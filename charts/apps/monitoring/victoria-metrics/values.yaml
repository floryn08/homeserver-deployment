# https://docs.victoriametrics.com/helm/victoria-metrics-single/
namespace: &namespace monitoring

host:
  subdomain: metrics

secrets:
  domain:
    key: homeDomain
    path: kv/data/domains

victoria-metrics-single:
  fullnameOverride: victoria-metrics
  server:
    namespaceOverride: *namespace

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

    retentionPeriod: "2" # months

    persistentVolume:
      enabled: true
      storageClass: manual
      size: 10Gi
      existingClaim: victoria-metrics

    scrape:
      enabled: true
      config:
        scrape_configs:
        - job_name: victoria-metrics
          static_configs:
          - targets: ["localhost:8428"]

        - job_name: kubernetes-nodes
          scheme: https
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            insecure_skip_verify: true
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kubernetes_sd_configs:
          - role: node
          relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - source_labels: [__meta_kubernetes_node_name]
            target_label: node

        - job_name: kubernetes-cadvisor
          scheme: https
          metrics_path: /metrics/cadvisor
          tls_config:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            insecure_skip_verify: true
          bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kubernetes_sd_configs:
          - role: node
          relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - source_labels: [__meta_kubernetes_node_name]
            target_label: node
          - source_labels: [__meta_kubernetes_node_name]
            target_label: instance
          metric_relabel_configs:
          - source_labels: [pod]
            target_label: pod_name
          - source_labels: [container]
            target_label: container_name

        - job_name: node-exporter
          kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names: [monitoring]
          relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: node-exporter
          - source_labels: [__meta_kubernetes_endpoint_node_name]
            target_label: node
          - source_labels: [__meta_kubernetes_endpoint_node_name]
            target_label: instance

        - job_name: kube-state-metrics
          static_configs:
          - targets: ["kube-state-metrics.monitoring.svc:8080"]

        - job_name: kubernetes-pods
          kubernetes_sd_configs:
          - role: pod
          relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name

  service:
    type: ClusterIP

prometheus-node-exporter:
  namespaceOverride: monitoring
  fullnameOverride: node-exporter
  service:
    type: ClusterIP

kube-state-metrics:
  namespaceOverride: monitoring
  fullnameOverride: kube-state-metrics
