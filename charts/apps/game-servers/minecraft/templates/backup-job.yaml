apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-backup-job
  namespace: {{ .Values.namespace }}
spec:
  schedule: "0 2 * * *"  # every night at 2AM
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: restic-backup
              image: restic/restic:latest
              command: ["/bin/sh", "/scripts/backup.sh"]
              env:
                - name: RESTIC_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}
                      key: RESTIC_PASSWORD
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}
                      key: AWS_ACCESS_KEY_ID
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}
                      key: AWS_SECRET_ACCESS_KEY
                - name: B2_BUCKET_PATH
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}
                      key: B2_BUCKET_PATH
              volumeMounts:
                - name: data-to-backup
                  mountPath: /data
                - name: local-backup
                  mountPath: /backups
                - name: backup-script
                  mountPath: /scripts
          restartPolicy: OnFailure
          volumes:
            - name: data-to-backup
              hostPath:
                path: {{ .Values.storage.appdataBasePath }}/{{ .Values.namespace }}/{{ .Release.Name }}
            - name: local-backup
              hostPath:
                path: /mnt/hdd2/backups/restic  # adjust to your local backup storage
            - name: backup-script
              configMap:
                name: {{ .Release.Name }}-backup-script
                defaultMode: 0775

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-backup-script
  namespace: {{ .Values.namespace }}
data:
  backup.sh: |
    #!/bin/sh
    set -eux

    LOCAL_REPO="/backups/minecraft"
    B2_REPO="s3:$B2_BUCKET_PATH"

    # Initialize local repo if it doesn't exist
    restic -r "$LOCAL_REPO" snapshots || restic -r "$LOCAL_REPO" init

    # Run backup
    restic -r "$LOCAL_REPO" backup /data

    # Initialize local repo if it doesn't exist
    restic -r "$B2_REPO" snapshots || restic -r "$B2_REPO" init

    # Run backup
    restic -r "$B2_REPO" backup /data

    # Forget old snapshots
    restic -r "$LOCAL_REPO" forget --keep-daily 7 --keep-weekly 4 --keep-monthly 3 --prune
    
    # Forget old snapshots
    restic -r "$B2_REPO" forget --keep-daily 7 --keep-weekly 4 --keep-monthly 3 --prune