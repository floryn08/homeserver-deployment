apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-backup-job
  namespace: {{ .Values.namespace }}
spec:
  schedule: "0 3 * * *"  # every night at 3AM
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: pg-dump
              image: postgres:18-alpine
              command: ["/bin/sh", "-c"]
              args:
                - |
                  #!/bin/sh
                  set -eux

                  # Run pg_dump to backup all databases
                  PGPASSWORD="$POSTGRES_PASSWORD" pg_dumpall -h postgresql-postgresql -U postgres -f /postgres-dumps/postgresql-backup.sql

                  # Signal completion
                  touch /postgres-dumps/.pg-dump-done
              env:
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}
                      key: POSTGRES_PASSWORD
              volumeMounts:
                - name: postgres-backup-dump
                  mountPath: /postgres-dumps

            - name: restic
              image: restic/restic:latest
              command: ["/bin/sh", "-c"]
              args: 
                - |
                  #!/bin/sh
                  set -eux

                  # Wait for pg_dump to finish
                  while [ ! -f /postgres-dumps/.pg-dump-done ]; do
                    sleep 5
                  done

                  LOCAL_REPO="/backups/{{ .Release.Name }}"

                  # Initialize local repo if it doesn't exist
                  restic -r "$LOCAL_REPO" snapshots || restic -r "$LOCAL_REPO" init

                  # Run backup
                  restic -r "$LOCAL_REPO" backup /postgres-dumps --host {{ .Release.Name }}-backup

                  # Forget old snapshots
                  restic -r "$LOCAL_REPO" forget --keep-daily 7 --keep-weekly 4 --keep-monthly 3 --prune
                  
                  # Create a file to signal completion
                  touch /backups/{{ .Release.Name }}/.restic-done
                  
                  # Remove pg-dump signal
                  rm /postgres-dumps/.pg-dump-done
              env:
                - name: RESTIC_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}-backup-job
                      key: RESTIC_PASSWORD                
              volumeMounts:
                - name: postgres-backup-dump
                  mountPath: /postgres-dumps
                - name: local-backup
                  mountPath: /backups

            - name: rclone
              image: rclone/rclone:latest
              env:
                - name: B2_ACCOUNT_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}-backup-job
                      key: B2_ACCOUNT_ID
                - name: B2_ACCOUNT_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}-backup-job
                      key: B2_ACCOUNT_KEY
                - name: B2_BUCKET
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Release.Name }}-backup-job
                      key: B2_BUCKET
              volumeMounts:
                - name: local-backup
                  mountPath: /backups
              command: ["/bin/sh", "-c"]
              args:
                - |
                  #!/bin/sh
                  set -eux
                  LOCAL_REPO="/backups/{{ .Release.Name }}"
                  B2_BUCKET="$B2_BUCKET"
                  B2_PATH="{{ .Release.Name }}"

                  # Wait for restic to finish
                  while [ ! -f "$LOCAL_REPO/.restic-done" ]; do
                    sleep 5
                  done

                  # Configure rclone dynamically
                  export RCLONE_CONFIG_B2REMOTE_TYPE=b2
                  export RCLONE_CONFIG_B2REMOTE_ACCOUNT=$B2_ACCOUNT_ID
                  export RCLONE_CONFIG_B2REMOTE_KEY=$B2_ACCOUNT_KEY

                  # Sync to B2
                  rclone sync "$LOCAL_REPO" "b2remote:${B2_BUCKET}/${B2_PATH}" --fast-list --transfers=4 --checkers=8 -v -P

                  # Remove completion signal for next run
                  rm "$LOCAL_REPO/.restic-done"
          restartPolicy: OnFailure
          volumes:
            - name: postgres-backup-dump
              emptyDir: {}
            - name: local-backup
              hostPath:
                path: /mnt/hdd2/backups/restic  # adjust to your local backup storage
