apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: vaultstaticsecret-{{ .Release.Name }}
  namespace: {{ .Values.namespace }}
spec:
  vaultAuthRef: vaultauth-{{ .Values.namespace }}
  mount: kv
  type: kv-v2
  path: {{ .Values.namespace }}/{{ .Release.Name }}
  destination:
    name: {{ .Release.Name }}
    create: true
    overwrite: true
    transformation:
      templates:
        PAPERLESS_URL: 
          text: | 
            https://paperless-ngx.{{ "{{-" }} printf "%s" (get .Secrets "localDomain") {{ "-}}" }}
        PAPERLESS_APPS: 
          text: |
            allauth.socialaccount.providers.openid_connect
        PAPERLESS_SOCIALACCOUNT_PROVIDERS:
          text: |
            {
              "openid_connect": {
                "APPS": [
                  {
                    "provider_id": "authentik",
                    "name": "Authentik",
                    "client_id": "{{ "{{-" }} printf "%s" (get .Secrets "authentikClientId") {{ "-}}" }}",
                    "secret": "{{ "{{-" }} printf "%s" (get .Secrets "authentikClientId") {{ "-}}" }}",
                    "settings": {
                      "server_url": "https://auth.{{ "{{-" }} printf "%s" (get .Secrets "authentikDomain") {{ "-}}" }}/application/o/paperless/.well-known/openid-configuration"
                    }
                  }
                ],
                "OAUTH_PKCE_ENABLED": "True"
              }
            }